server {
    # TLS configuration (uncomment and configure for HTTPS)
    #
    # ssl_certificate /etc/ssl/certs/example.com.pem;
    # ssl_certificate_key /etc/ssl/private/example.com.key;
    # include snippets/tls_hardening.conf;
    # add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # Site-specific variables
    set $php_sock unix:/var/run/php/example.com8.4.sock;
    set $MAGE_ROOT /var/www/example.com;

    # Important: Root MUST be pub/ directory for security
    root $MAGE_ROOT/pub;
    
    server_name example.com www.example.com;

    index index.php;

    # Security headers (customize as needed)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Main location - route everything through index.php
    location / {
        fastcgi_param SCRIPT_FILENAME $MAGE_ROOT/pub/index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_NAME /index.php;
        fastcgi_pass $php_sock;
    }

    # Include Magento universal hardening rules
    include snippets/magento/magento_hardening.conf;

    # Static content serving
    location /static/ {
        expires max;
        log_not_found off;

        # Version removal rewrite
        location ~ ^/static/version\d*/ {
            rewrite ^/static/version\d*/(.*)$ /static/$1 last;
        }
    }

    # Media content serving
    location /media/ {
        expires max;
        log_not_found off;
    }

    # Site-specific security rules (configure as needed)

    # Allowed PHP entry points
    location ~ ^/(index|get|static|errors/report|errors/404|errors/503|health_check)\.php$ {
        # limit_req zone=magentophp burst=30 nodelay;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $MAGE_ROOT/pub$fastcgi_script_name;
        fastcgi_pass $php_sock;
    }
}
